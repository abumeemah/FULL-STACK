<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FiCore Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #B88A44;
            --secondary-color: #917243;
            --success-color: #10B981;
            --warning-color: #F59E0B;
            --danger-color: #EF4444;
        }

        .navbar-brand {
            color: var(--primary-color) !important;
            font-weight: bold;
        }

        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-primary:hover {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }

        .card-header {
            background-color: var(--primary-color);
            color: white;
        }

        .status-pending {
            background-color: var(--warning-color);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
        }

        .status-approved {
            background-color: var(--success-color);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
        }

        .status-rejected {
            background-color: var(--danger-color);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
        }

        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        }

        .login-card {
            max-width: 400px;
            width: 100%;
        }

        #loginError {
            min-height: 40px;
        }
    </style>
</head>

<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="card login-card">
            <div class="card-header text-center">
                <h4><i class="fas fa-shield-alt"></i> FiCore Admin Login</h4>
            </div>
            <div class="card-body">
                <form id="loginForm">
                    <div class="mb-3">
                        <label for="email" class="form-label">Admin Email</label>
                        <input type="email" class="form-control" id="email" value="admin@ficore.com" required>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Password</label>
                        <input type="password" class="form-control" id="password" value="admin123" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-sign-in-alt"></i> Login
                    </button>
                </form>
                <div id="loginError" class="alert alert-danger mt-3" style="display: none;"></div>

                <!-- API Configuration -->
                <div class="mt-3">
                    <h6>API Configuration:</h6>
                    <div class="input-group input-group-sm">
                        <span class="input-group-text">Backend URL</span>
                        <input type="text" class="form-control" id="customApiUrl"
                            placeholder="https://your-backend.render.com">
                        <button class="btn btn-outline-secondary" type="button" onclick="updateApiUrl()">Update</button>
                    </div>
                    <small class="text-muted">Current API: <span id="apiUrl">Loading...</span></small>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboardScreen" style="display: none;">
        <!-- Navigation -->
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <div class="container-fluid">
                <a class="navbar-brand" href="#"><i class="fas fa-coins"></i> FiCore Admin</a>
                <div class="navbar-nav ms-auto">
                    <span class="navbar-text me-3">Welcome, <span id="adminName">Admin</span></span>
                    <button class="btn btn-outline-danger btn-sm" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>
        </nav>

        <div class="container-fluid mt-4">
            <!-- Statistics Cards -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card text-white bg-primary">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 id="totalUsers">0</h4>
                                    <p class="mb-0">Total Users</p>
                                </div>
                                <i class="fas fa-users fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-white bg-warning">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 id="pendingRequests">0</h4>
                                    <p class="mb-0">Pending Requests</p>
                                </div>
                                <i class="fas fa-clock fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-white bg-success">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 id="approvedRequests">0</h4>
                                    <p class="mb-0">Approved</p>
                                </div>
                                <i class="fas fa-check fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-white bg-danger">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4 id="rejectedRequests">0</h4>
                                    <p class="mb-0">Rejected</p>
                                </div>
                                <i class="fas fa-times fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabs -->
            <ul class="nav nav-tabs" id="adminTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="requests-tab" data-bs-toggle="tab" data-bs-target="#requests"
                        type="button" role="tab">
                        <i class="fas fa-credit-card"></i> Credit Requests
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button"
                        role="tab">
                        <i class="fas fa-users"></i> Users
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="adminTabsContent">
                <!-- Credit Requests Tab -->
                <div class="tab-pane fade show active" id="requests" role="tabpanel">
                    <div class="card mt-3">
                        <div class="card-header">
                            <h5><i class="fas fa-credit-card"></i> Credit Requests Management</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Request ID</th>
                                            <th>User</th>
                                            <th>Amount</th>
                                            <th>Payment Method</th>
                                            <th>Status</th>
                                            <th>Date</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="requestsTableBody">
                                        <tr>
                                            <td colspan="7" class="text-center">Loading...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Users Tab -->
                <div class="tab-pane fade" id="users" role="tabpanel">
                    <div class="card mt-3">
                        <div class="card-header">
                            <h5><i class="fas fa-users"></i> Users Management</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>User ID</th>
                                            <th>Email</th>
                                            <th>Name</th>
                                            <th>Credit Balance</th>
                                            <th>Status</th>
                                            <th>Joined</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="usersTableBody">
                                        <tr>
                                            <td colspan="7" class="text-center">Loading...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Admin Web App JavaScript
        let API_BASE_URL = (() => {
            const customApiUrl = localStorage.getItem('customApiUrl');
            if (customApiUrl) {
                return customApiUrl;
            }

            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                return 'http://localhost:5000';
            }

            return window.location.origin;
        })();

        console.log('🔗 API Base URL:', API_BASE_URL);
        let authToken = null;
        let currentRequestId = null;

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function () {
            console.log('DOM loaded, initializing admin app');
            document.getElementById('apiUrl').textContent = API_BASE_URL;
            document.getElementById('customApiUrl').value = API_BASE_URL;

            const savedToken = localStorage.getItem('adminToken');
            if (savedToken) {
                console.log('Found saved token, attempting to show dashboard');
                authToken = savedToken;
                showDashboard();
                loadDashboardData();
            }

            const loginForm = document.getElementById('loginForm');
            loginForm.addEventListener('submit', handleLogin);
            console.log('Login form listener attached');
        });

        function updateApiUrl() {
            const newUrl = document.getElementById('customApiUrl').value.trim();
            if (newUrl && newUrl !== API_BASE_URL) {
                localStorage.setItem('customApiUrl', newUrl);
                API_BASE_URL = newUrl;
                alert('API URL updated successfully. You can now try logging in.');
                document.getElementById('apiUrl').textContent = API_BASE_URL;
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            console.log('Login form submitted');
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            console.log('Login attempt for:', email);

            try {
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, password })
                });

                console.log('Login response status:', response.status);
                const data = await response.json();
                console.log('Login response data:', data);

                if (data.success && data.data.user.role === 'admin') {
                    authToken = data.data.token || data.data.access_token;
                    localStorage.setItem('adminToken', authToken);
                    document.getElementById('adminName').textContent = data.data.user.displayName || 'Admin';
                    showDashboard();
                    loadDashboardData();
                } else if (data.success && data.data.user.role !== 'admin') {
                    showError('Access denied: Admin privileges required');
                } else {
                    showError(data.message || 'Invalid admin credentials');
                }
            } catch (error) {
                console.error('Login error:', error);
                if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                    showError('Connection failed: Unable to reach the backend server. Please check the API URL.');
                } else {
                    showError('Login failed: ' + error.message);
                }
            }
        }

        function showDashboard() {
            console.log('Showing dashboard');
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('dashboardScreen').style.display = 'block';
        }

        function showLogin() {
            console.log('Showing login screen');
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('dashboardScreen').style.display = 'none';
        }

        function showError(message) {
            console.log('Showing error:', message);
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function logout() {
            console.log('Logging out');
            localStorage.removeItem('adminToken');
            authToken = null;
            showLogin();
        }

        async function loadDashboardData() {
            console.log('Loading dashboard data');
            await Promise.all([
                loadStatistics(),
                loadCreditRequests(),
                loadUsers()
            ]);
        }

        async function loadStatistics() {
            try {
                const usersResponse = await fetch(`${API_BASE_URL}/admin/users`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const usersData = await usersResponse.json();
                console.log('Users response:', usersData);

                const requestsResponse = await fetch(`${API_BASE_URL}/admin/credit-requests`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const requestsData = await requestsResponse.json();
                console.log('Credit requests response:', requestsData);

                if (usersData.success) {
                    document.getElementById('totalUsers').textContent = usersData.data.pagination.total;
                }

                if (requestsData.success) {
                    const stats = requestsData.data.statistics;
                    document.getElementById('pendingRequests').textContent = stats.pending;
                    document.getElementById('approvedRequests').textContent = stats.approved;
                    document.getElementById('rejectedRequests').textContent = stats.rejected;
                }
            } catch (error) {
                console.error('Failed to load statistics:', error);
            }
        }

        async function loadCreditRequests() {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/credit-requests`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();
                console.log('Credit requests response:', data);
                if (data.success) {
                    displayCreditRequests(data.data.requests);
                }
            } catch (error) {
                console.error('Failed to load credit requests:', error);
                document.getElementById('requestsTableBody').innerHTML =
                    '<tr><td colspan="7" class="text-center text-danger">Failed to load requests</td></tr>';
            }
        }

        function displayCreditRequests(requests) {
            console.log('Displaying credit requests:', requests);
            const tbody = document.getElementById('requestsTableBody');
            if (requests.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">No credit requests found</td></tr>';
                return;
            }
            tbody.innerHTML = requests.map(request => `
                <tr>
                    <td>${request.requestId}</td>
                    <td>
                        <div>${request.user?.displayName || 'Unknown'}</div>
                        <small class="text-muted">${request.user?.email || ''}</small>
                    </td>
                    <td>₦${request.amount.toLocaleString()}</td>
                    <td>${request.paymentMethod}</td>
                    <td><span class="status-${request.status}">${request.status.toUpperCase()}</span></td>
                    <td>${new Date(request.createdAt).toLocaleDateString()}</td>
                    <td>
                        ${request.status === 'pending' ? `
                            <button class="btn btn-sm btn-primary" onclick="showRequestModal('${request.requestId}', ${JSON.stringify(request).replace(/"/g, '&quot;')})">
                                <i class="fas fa-edit"></i> Process
                            </button>
                        ` : `
                            <button class="btn btn-sm btn-outline-secondary" onclick="viewRequestDetails('${request.requestId}')">
                                <i class="fas fa-eye"></i> View
                            </button>
                        `}
                    </td>
                </tr>
            `).join('');
        }

        async function loadUsers() {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/users`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();
                console.log('Users response:', data);
                if (data.success) {
                    displayUsers(data.data.users);
                }
            } catch (error) {
                console.error('Failed to load users:', error);
                document.getElementById('usersTableBody').innerHTML =
                    '<tr><td colspan="7" class="text-center text-danger">Failed to load users</td></tr>';
            }
        }

        function displayUsers(users) {
            console.log('Displaying users:', users);
            const tbody = document.getElementById('usersTableBody');
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">No users found</td></tr>';
                return;
            }
            tbody.innerHTML = users.map(user => `
                <tr>
                    <td>${user.id}</td>
                    <td>${user.email}</td>
                    <td>${user.displayName || 'Not set'}</td>
                    <td>${user.ficoreCreditBalance.toLocaleString()} FCs</td>
                    <td>
                        <span class="badge ${user.isActive ? 'bg-success' : 'bg-danger'}">
                            ${user.isActive ? 'Active' : 'Inactive'}
                        </span>
                    </td>
                    <td>${new Date(user.createdAt).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="adjustUserCredits('${user.id}', '${user.displayName}', ${user.ficoreCreditBalance})">
                            <i class="fas fa-coins"></i> Adjust Credits
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function showSuccessMessage(message) {
            console.log('Showing success message:', message);
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed';
            alertDiv.style.top = '20px';
            alertDiv.style.right = '20px';
            alertDiv.style.zIndex = '9999';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 3000);
        }
    </script>
</body>

</html>